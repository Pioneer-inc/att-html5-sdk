<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='SampleApp-controller-mms-Coupon'>/**
</span> * Controller that interacts with the Coupon MMS application.
 */
Ext.define('SampleApp.controller.mms.Coupon', {
    extend: 'Ext.app.Controller',
    
    requires:[
        'Att.Provider',     
        'Att.ApiResults',
        'SampleApp.Config',
        'Ext.MessageBox'
    ],
    
    config: {
<span id='SampleApp-controller-mms-Coupon-cfg-provider'>        provider: undefined,
</span>
<span id='SampleApp-controller-mms-Coupon-cfg-refs'>        refs: {
</span>            view: 'att-mms-coupon',
            responseView: {
                xtype: 'apiresults',
                selector: 'apiresults',
                hidden: true,
                autoCreate: true
            }
        },
        
<span id='SampleApp-controller-mms-Coupon-cfg-control'>        control: {
</span>            'att-mms-coupon': {
                initialize: 'loadData',
            },
            'att-mms-coupon button[action=sendmessage]': {
                tap: 'onSendMms'
            },
            'att-mms-coupon button[action=messagestatus]':{
                tap: 'onMessageStatus'
            },
            'actionsheet button[action=close]': {
                'tap': 'onCloseResponseView'
            }
        }
    },
    
<span id='SampleApp-controller-mms-Coupon-method-applyProvider'>    /**
</span>     * Gets called internally when provider property is set during config initialization.
     * We'll initialize here our Att.Provider instance to perform the API calls. 
     * @param provider the value we set in config option for this property.
     * @returns
     */
    applyProvider: function(provider) {
        if (!provider) {
            provider = Ext.create('Att.Provider',{
                apiBasePath: SampleApp.Config.apiBasePath
            });
        }

        return provider;
    },
    
    
<span id='SampleApp-controller-mms-Coupon-method-showResponseView'>    showResponseView: function(success, response){
</span>        var responseView =  this.getResponseView();
       
        Ext.Viewport.add(responseView);
       
        responseView.setData({
            success: success,
            results: JSON.stringify(response, null, '\t')
        });
       
        responseView.show();    
    },
    
<span id='SampleApp-controller-mms-Coupon-method-onCloseResponseView'>    onCloseResponseView: function(){
</span>        this.getResponseView().hide();
    },

<span id='SampleApp-controller-mms-Coupon-method-onSendMms'>    /**
</span>     * Handler for send Mms button. 
     * It will pull the value from address and message inputs to perform a sendMms call.
     */
    onSendMms: function(btn, event, eOpts) {
        var me = this,
            provider = me.getProvider(),
            view = me.getView(),
            cfg = SampleApp.Config,
            form = btn.up('formpanel').getValues(),
            message = form.message,
            i = 0,
            addresses, l;
        
        //check phone numbers
        if(!form.address){
            Ext.Msg.alert(cfg.alertTitle, cfg.invalidPhoneMsg);
            return;
        }
        
        addresses = form.address.split(',');
        
        l = addresses.length;
        for(; i &lt; l ; i++){
            address = addresses[i].trim();
            if(!Att.Provider.isValidPhoneNumber(address)){
                Ext.Msg.alert(cfg.alertTitle, cfg.invalidPhoneMsg);
                return;
            }
            addresses[i] = Att.Provider.normalizePhoneNumber(address);
        }
        
        // check message 
        if (message === '') {
            Ext.Msg.alert(cfg.alertTitle, 'Please enter a message');
            return;
        }
        
        view.setMasked(true);
        
        provider.sendMms({
            address  : addresses.join(','),
            fileId   : &quot;coupon.jpg&quot;,
            message  : message,
            priority : &quot;High&quot;,
            success: function(response){
                view.setMasked(false);
                me.showResponseView(true, response);
                //set the message Id value 
                view.down('formpanel textfield[name=mmsId]').setValue(response.Id);
            },
            failure: function(error){
                view.setMasked(false);
                me.showResponseView(false, error);
            }
        });   
        
    },
    
<span id='SampleApp-controller-mms-Coupon-method-onMessageStatus'>    /**
</span>     * Handler for get Status button.
     * Once we perform a sendMms call, the mmsId input is populated with the response. 
     * That field is used in this function to retrieve the status of the message.
     */
    onMessageStatus: function(btn, event, eOpts) {
        var me = this,
            provider = me.getProvider(),
            view = me.getView(),
            cfg = SampleApp.Config,
            form = btn.up('formpanel').getValues(),
            mmsId = form.mmsId;
        
        // check message id
        if (!mmsId) {
            Ext.Msg.alert(cfg.alertTitle, 'Please enter a Message Id');
            return;
        }
        
        
        view.setMasked(true);
        
        provider.getMmsStatus({
            mmsId  : mmsId,
            success: function(response){
                var list = view.down('list');
                view.setMasked(false);
                me.showResponseView(true, response);
                if(response.DeliveryInfoList){
                    //add status to list 
                    list.getStore().setData(response.DeliveryInfoList.DeliveryInfo);
                }
            },
            failure: function(error){
                view.setMasked(false);
                me.showResponseView(false, error);
            }
        });  
    },
    
<span id='SampleApp-controller-mms-Coupon-method-loadData'>    //private
</span>    loadData: function() {
        this.loadPhoneList();
        this.loadSubjectData();
    },

<span id='SampleApp-controller-mms-Coupon-method-loadPhoneList'>    //private
</span>    loadPhoneList: function() {
        var view = this.getView();
        
        view.setMasked(true);
        
        Ext.Ajax.request({
            url : 'assets/data/phones.txt',
            success : function(response, opts) {
                view.down('textfield[name=address]').setValue(response.responseText);
                view.setMasked(false);
            },
            failure : function(response, opts) {
                Ext.Msg.alert('Error', 'There was an error loading the phone number(s) from the phones.txt file.');
                view.setMasked(false);
            }
        });
    },
    
<span id='SampleApp-controller-mms-Coupon-method-loadSubjectData'>    //private
</span>    loadSubjectData: function() {
        var view = this.getView();
        
        view.setMasked(true);
        
        Ext.Ajax.request({
            url : 'assets/data/message.txt',
            success : function(response, opts) {
                view.down('textareafield[name=subject]').setValue(response.responseText);
                view.setMasked(false);
            },
            failure : function(response, opts) {
                Ext.Msg.alert('Error', 'There was an error loading the Subject from the message.txt file.');
                view.setMasked(false);
            }
        });
    }
});</pre>
</body>
</html>
